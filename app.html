<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descargador Ok.ru - Alta Calidad</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Animación de carga */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>

    <!-- Contenedor principal donde React montará la app -->
    <div id="root" class="min-h-screen flex items-center justify-center">
        <div class="text-white text-xl">Cargando aplicación...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONOS SVG INTEGRADOS (Para evitar errores de librerías externas) ---
        const IconVideo = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>
        );
        const IconLink = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        );
        const IconDownload = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        );
        const IconAlert = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );
        const IconLoader = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin-custom"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        );

        function App() {
            const [url, setUrl] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [videoData, setVideoData] = useState(null);

            const extractVideoId = (inputUrl) => {
                try {
                    const regex = /(?:ok\.ru\/|ok\.ru\/video\/|ok\.ru\/live\/)(\d+)/;
                    const match = inputUrl.match(regex);
                    return match ? match[1] : null;
                } catch (e) {
                    return null;
                }
            };

            const handleSearch = async (e) => {
                e.preventDefault();
                setError(null);
                setVideoData(null);
                setLoading(true);

                const videoId = extractVideoId(url);

                if (!videoId) {
                    setError("No se encontró un ID válido. Asegúrate de usar un enlace como https://ok.ru/video/12345");
                    setLoading(false);
                    return;
                }

                try {
                    // Usamos un proxy diferente (corsproxy.io) como respaldo si allorigins falla
                    const metadataUrl = `https://ok.ru/dk?cmd=videoPlayerMetadata&mid=${videoId}`;
                    // Alternativa: `https://api.allorigins.win/get?url=${encodeURIComponent(metadataUrl)}`
                    // Usamos allorigins para mayor estabilidad en JSON
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(metadataUrl)}`;

                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error("Error de red al contactar el proxy");
                    
                    const data = await response.json();
                    
                    if (!data.contents) throw new Error("No se pudo obtener datos de Ok.ru");

                    // Parsear el contenido que viene como string
                    let okruData;
                    try {
                        okruData = JSON.parse(data.contents);
                    } catch (e) {
                        throw new Error("La respuesta de Ok.ru no es válida.");
                    }

                    if (okruData.error) {
                        throw new Error("El video es privado o ha sido eliminado.");
                    }

                    if (okruData.videos && okruData.videos.length > 0) {
                        const qualityOrder = { 'mobile': 0, 'lowest': 1, 'low': 2, 'sd': 3, 'hd': 4, 'full': 5, 'quad': 6 };
                        
                        const sortedVideos = okruData.videos.sort((a, b) => {
                            const qA = qualityOrder[a.name] || 0;
                            const qB = qualityOrder[b.name] || 0;
                            return qB - qA;
                        });

                        setVideoData({
                            title: okruData.movie.title || "Video sin título",
                            poster: okruData.movie.poster || "",
                            author: okruData.author ? okruData.author.name : "Desconocido",
                            duration: okruData.movie.duration,
                            qualities: sortedVideos
                        });
                    } else {
                        throw new Error("No se encontraron enlaces de descarga directos.");
                    }

                } catch (err) {
                    console.error(err);
                    setError(err.message || "Error desconocido al procesar el video.");
                } finally {
                    setLoading(false);
                }
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };

            const getQualityLabel = (name) => {
                switch(name) {
                    case 'quad': return '4K (Quad)';
                    case 'full': return '1080p (Full HD)';
                    case 'hd': return '720p (HD)';
                    case 'sd': return '480p (SD)';
                    case 'low': return '360p';
                    case 'lowest': return '240p';
                    case 'mobile': return '144p';
                    default: return name.toUpperCase();
                }
            };

            return (
                <div className="w-full max-w-2xl px-4 py-8">
                    
                    {/* Header */}
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-orange-500 mb-2 flex items-center justify-center gap-3">
                            <IconVideo />
                            OK.RU Downloader
                        </h1>
                        <p className="text-slate-400">Descargador de video directo</p>
                    </div>

                    {/* Search Box */}
                    <div className="glass-panel rounded-2xl p-6 shadow-2xl mb-6">
                        <form onSubmit={handleSearch} className="flex flex-col md:flex-row gap-4">
                            <div className="relative flex-grow">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">
                                    <IconLink />
                                </div>
                                <input 
                                    type="text" 
                                    className="w-full pl-10 pr-4 py-3 bg-slate-800 border border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none text-white placeholder-slate-500 transition-all"
                                    placeholder="https://ok.ru/video/..."
                                    value={url}
                                    onChange={(e) => setUrl(e.target.value)}
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-8 rounded-xl transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                            >
                                {loading ? <IconLoader /> : <IconDownload />}
                                {loading ? "..." : "Buscar"}
                            </button>
                        </form>
                    </div>

                    {/* Error Message */}
                    {error && (
                        <div className="bg-red-900/30 border border-red-500/50 text-red-200 p-4 rounded-xl mb-6 flex items-center gap-3">
                            <div className="text-red-500 flex-shrink-0"><IconAlert /></div>
                            <p>{error}</p>
                        </div>
                    )}

                    {/* Results */}
                    {videoData && (
                        <div className="glass-panel rounded-2xl p-6 shadow-2xl animate-fade-in">
                            <div className="flex flex-col md:flex-row gap-6">
                                {/* Thumbnail */}
                                <div className="w-full md:w-1/3">
                                    <div className="aspect-video bg-slate-800 rounded-lg overflow-hidden relative shadow-lg">
                                        <img 
                                            src={videoData.poster} 
                                            alt={videoData.title} 
                                            className="w-full h-full object-cover"
                                            onError={(e) => {e.target.src = 'https://via.placeholder.com/320x180?text=No+Preview'}}
                                        />
                                        <div className="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                                            {formatTime(videoData.duration)}
                                        </div>
                                    </div>
                                </div>

                                {/* Info & Links */}
                                <div className="w-full md:w-2/3">
                                    <h2 className="text-xl font-bold text-white mb-2 line-clamp-2">{videoData.title}</h2>
                                    <p className="text-slate-400 text-sm mb-4">Autor: <span className="text-orange-400">{videoData.author}</span></p>
                                    
                                    <div className="space-y-3">
                                        <p className="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-2">Descargas:</p>
                                        <div className="grid grid-cols-1 gap-2">
                                            {videoData.qualities.map((video, index) => (
                                                <a 
                                                    key={index}
                                                    href={video.url}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="group flex items-center justify-between bg-slate-700/50 hover:bg-orange-600/20 border border-slate-600 hover:border-orange-500 rounded-lg p-3 transition-all"
                                                >
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-2 h-2 rounded-full ${['full', 'quad', 'hd'].includes(video.name) ? 'bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]' : 'bg-slate-400'}`}></div>
                                                        <span className="font-mono font-bold text-white">
                                                            {getQualityLabel(video.name)}
                                                        </span>
                                                    </div>
                                                    <IconDownload />
                                                </a>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
